#!/usr/bin/with-contenv bashio

set -e
bashio::log.info "== Keycloak Add-on starting =="

# Wait for MariaDB
bashio::log.info "Looking for MariaDB..."
if ! bashio::services.available 'mysql'; then
    bashio::log.fatal "Local database access should be provided by the MariaDB addon"
    bashio::exit.nok "Please ensure it is installed and started"
fi

export DB_ADDR=$(bashio::services "mysql" "host")
export DB_PORT=$(bashio::services "mysql" "port")
export DB_DATABASE=$(bashio::config 'db_name')
export DB_USER=$(bashio::config 'db_user')
export DB_PASSWORD=$(bashio::config 'db_password')
export KEYCLOAK_ADMIN=$(bashio::config 'KEYCLOAK_ADMIN')
export KEYCLOAK_ADMIN_PASSWORD=$(bashio::config 'KEYCLOAK_ADMIN_PASSWORD')
export KC_HOSTNAME=keycloak.local

bashio::log.info "MariaDB: ${DB_USER}@${DB_ADDR}:${DB_PORT}/${DB_DATABASE}"

## Run your program
exec /opt/keycloak/bin/kc.sh start \
  --proxy-headers=xforwarded \
  --hostname-strict=false \
  ${KC_HOSTNAME:+--hostname=${KC_HOSTNAME}} \
  --db=mariadb \
  --db-url=jdbc:mariadb://${DB_ADDR}:${DB_PORT}/${DB_DATABASE} \
  --db-username=${DB_USER} \
  --db-password=${DB_PASSWORD} \
  --features=token-exchange
