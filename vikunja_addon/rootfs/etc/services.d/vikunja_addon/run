#!/usr/bin/with-contenv bashio

bashio::log.info "Starting Vikunja..."

# Wait for MariaDB
bashio::log.info "Looking for MariaDB..."
if ! bashio::services.available 'mysql'; then
    bashio::log.fatal "Local database access should be provided by the MariaDB addon"
    bashio::exit.nok "Please ensure it is installed and started"
fi

db_host=$(bashio::services "mysql" "host")
db_port=$(bashio::services "mysql" "port")
db_user=$(bashio::config 'db_user')
db_pass=$(bashio::config 'db_password')
db_name=$(bashio::config 'db_name')
public_url=$(bashio::config 'public_url')
jwt_secret=$(bashio::config 'jwt_secret')
allow_register=$(bashio::config 'allow_register')

files_dir="/data/files"
mkdir -p "${files_dir}"
chown -R 1000 "${files_dir}" || true

export VIKUNJA_DATABASE_TYPE="mysql"
export VIKUNJA_DATABASE_HOST="${db_host}"
export VIKUNJA_DATABASE_PORT="${db_port}"
export VIKUNJA_DATABASE_USER="${db_user}"
export VIKUNJA_DATABASE_PASSWORD="${db_pass}"
export VIKUNJA_DATABASE_DATABASE="${db_name}"
export VIKUNJA_SERVICE_JWTSECRET="${jwt_secret:-changeme}"
export VIKUNJA_SERVICE_PUBLICURL="${public_url}"
export VIKUNJA_SERVICE_ENABLEREGISTRATION="$([ "${allow_register}" = "true" ] && echo "true" || echo "false")"
export VIKUNJA_FILES_BASEPATH="${files_dir}"

exec /opt/vikunja/vikunja
